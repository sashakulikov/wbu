<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen 1</title>
    <style>
        @font-face {
            font-family: "Times";
            src: url("TimesNRCondensed.otf") format("opentype");
            font-weight: initial;
        }

        @font-face {
            font-family: 'CopyTrial';
            src: url('CopyTrial-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        h1 {
            font-family: "Times";
            font-weight: initial;
            width: 90%;
            position: absolute;
            text-align: center;
            top: 42%;
            left: 50%;
            transform: translate(-50%, -50%);
            letter-spacing: -7px;
            line-height: 117%;
            font-size: 10vh;
        }

        .caption-1, .caption-2 {
            font-family: "Arial";
            width: 100%;
            position: absolute;
            text-align: center;
            font-size: 2.8vh;
            letter-spacing: 0px;
        }

        .caption-1 {
            top: 3.1%;
        }

        .caption-2 {
            bottom: 3.5%;
        }


        .screensaver {
            z-index: 1000;
            width: 100%;
            height: 100%;
            position: absolute;
        }

        body.template1 {
            background-color: #1D1D1D;
        }

        body.template2 {
            background-color: #bfb5ca;
        }


        body.template1 .sasha {
            display: none;
        }

        body.template2 .sonya {
            display: none;
        }

        body.template1 h1 {
            color: #fff;
            -webkit-text-stroke: 1.5px rgb(255, 255, 255);
        }

        body.template2 h1 {
            color: #000;
            -webkit-text-stroke: 2px black;
        }

        body.template1 .caption-1 {
            color: #fff;
            -webkit-text-stroke: 0.8px rgb(255, 255, 255);
        }

        body.template1 .caption-2 {
            color: #fff;
            -webkit-text-stroke: 0.8px rgb(255, 255, 255);
        }

        body.template2 .caption-1 {
            color: #000;
            -webkit-text-stroke: 1px black;
        }
    
        body.template2 .caption-2 {
            color: #000;
            -webkit-text-stroke: 1px black;
        }

        .info1 {
            margin: 0;
            padding: 0;
            width: 100% !important;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
            height: 100%;
            font-family: "CopyTrial";
            font-weight: normal;
            color: #ffffff;
            position: fixed;
            text-align: center;
            letter-spacing: -1.5px;
            line-height: 120%;
            font-size: 2.5vw;
            z-index: 100000000;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);

            display: flex;
            align-items: center;
            justify-content: center;
        }


        .info2 {
            margin: 0;
            padding: 0;
            width: 100% !important;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
            height: 100%;
            font-family: "CopyTrial";
            font-weight: normal;
            color: #000;
            position: fixed;
            text-align: center;
            letter-spacing: -1.5px;
            line-height: 120%;
            font-size: 2.5vw;
            z-index: 100000000;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);

            display: flex;
            align-items: center;
            justify-content: center;
        }

        #infoOverlay {
            margin: 0;
            padding: 0;
            width: 100% !important;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
            height: 100%;
            font-family: "CopyTrial";
            font-weight: normal;
            color: #000;
            width: 100vh;
            position: fixed;
            text-align: center;
            letter-spacing: -1.5px;
            line-height: 120%;
            font-size: 2.5vw;
            z-index: 100000000;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            display: false;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    
        body.template1 .info2 {
            display: none;
        }

        body.template2 .info1 {
            display: none;
        }
    


    </style>

    <script src="p5.min.js"></script>
    <script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>
</head>
<body>
    

    <div class="screensaver">
        <script src="p5.min.js"></script>
        <script src="script1-2-s.js"></script>
    <div> 
    <div class="caption-1 sonya">Sonya</div>

    <div class="caption-1 sasha">Sasha</div>

    <div class="caption-2" id="theme-name">Loading...</div>
    <h1 id="typed"></h1>
    
    <div class="infoOverlay" id="infoOverlay">
        <div class="info1">
        <p>These are Sonya's words, recorded as an interview on February 1, 2025, reduced to binary chains and rebuilt to name those feelings that fly away when she tries to name them.</p>
    </div>

    <div class="info2">
        <p>These are Sasha's words, recorded as an interview on January 18, 2025, fragmented by the language model and reassembled to tell about something whose name he doesn't yet know</p>
    </div>
</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARRByK3-QRN6BLv23JIPG7tUfcC3PU5Mk",
            authDomain: "sosa-test-bd8ca.firebaseapp.com",
            databaseURL: "https://sosa-test-bd8ca-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "sosa-test-bd8ca",
            storageBucket: "sosa-test-bd8ca.firebasestorage.app",
            messagingSenderId: "709279438846",
            appId: "1:709279438846:web:cb0a718e5a01374dbe52af"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let typedInstance = null;
        let isTyping = false; 
        let currentReplicaIndex = 0;
        let replicasScreen1 = []; // Store fetched phrases
        let isErasing = false; // To track if we are currently erasing text

        let myp5;

        const themesRef = ref(db, "themes");

        
        // Get the URL parameters
        const params = new URLSearchParams(window.location.search);
        // Get the value of 'screen', default to '1' if not present
        const screenValue = params.get('screen') || '1';
        document.body.classList.add(`template${screenValue}`);

        // Construct the dynamic property name
        const replicasScreenKey = `replicasScreen${screenValue}`;
        const replicasScreenKeyFunction = `ReplicasScreen${screenValue}`;


        const screensRef = ref(db, "/");

        update(screensRef, {
            screen1isRunning: false,
            screen2isRunning: false
        });



        // Info overlay
        const body = document.body;
        const infoOverlay = document.getElementById("infoOverlay");
    const infoRef = ref(db, "/"); // Reference to the root

    // Listen for changes in infoLayer and update the visibility of infoOverlay
    onValue(infoRef, (snapshot) => {
        if (snapshot.exists()) {
            const infoLayer = snapshot.val().infoLayer;
            
            console.log(`infoLayer changed to: ${infoLayer}`);
            infoOverlay.style.display = infoLayer ? "block" : "none";

            if (infoLayer) {
            body.classList.add("info-overlay-on");
        } else {
            body.classList.remove("info-overlay-on");
        }
    } else {
        console.log("No data available");
    }
}, (error) => {
    console.error("Error listening for data changes:", error);
});

    // Functions to toggle infoLayer
    function infoLayerTrue() {
        update(infoRef, { infoLayer: true })
            .then(() => console.log("✅ infoLayer set to true"))
            .catch(error => console.error("❌ Error updating infoLayer:", error));
    }

    function infoLayerFalse() {
        update(infoRef, { infoLayer: false })
            .then(() => console.log("✅ infoLayer set to false"))
            .catch(error => console.error("❌ Error updating infoLayer:", error));
    }

    // Set infoLayer to false at startup
    update(infoRef, { infoLayer: false })
        .then(() => console.log("✅ infoLayer set to false at startup"))
        .catch(error => console.error("❌ Error setting infoLayer to false:", error));

        

        function showNextReplica() {

            update(screensRef, {
                [`screen${screenValue}isRunning`]: true,
            });

            console.log("showNextReplica: ");
            console.log(replicasScreen1);
            if (!replicasScreen1 || replicasScreen1.length === 0) {
                console.warn("⚠️ No valid replicas found.");
                return;
            }

            // Check if the currentReplicaIndex is within the bounds of the array
            if (currentReplicaIndex < replicasScreen1.length) {
                if (!isTyping && !isErasing) { // Don't type if we are erasing
                    isTyping = true;
                    console.log("🚀 Typing new text:", replicasScreen1[currentReplicaIndex]);

                    typedInstance = new Typed("#typed", {
                        strings: [replicasScreen1[currentReplicaIndex]],
                        typeSpeed: 40,
                        backSpeed: 20,
                        startDelay: 500,
                        backDelay: 0,
                        loop: false,
                        showCursor: false,
                        onComplete: () => {
                            console.log("✅ Typing complete for:", replicasScreen1[currentReplicaIndex]);
                            currentReplicaIndex++; // Move to the next phrase
                            isTyping = false;
                            let delay = currentReplicaIndex === 1 ? 1000 : 10000; // 2 seconds for the first phrase, 4 seconds for the rest
                            if (currentReplicaIndex < replicasScreen1.length) {
                                // Wait for the specified delay before erasing and showing the next phrase
                                setTimeout(() => {
                                    eraseCurrentText();
                                }, delay);
                            }
                        }
                    });
                }
            } else {
                console.log("🚫 No more phrases to show!");

            }
        }
        

        function eraseCurrentText() {
            if (typedInstance) {
                typedInstance.backspace(typedInstance.strings[0].length, 40); // Delete the current phrase
                isErasing = true; // Mark that we are erasing text
                setTimeout(() => {
                    isErasing = false;
                    showNextReplica(); // Now show the second phrase
                }, 1000); // Wait for 1 second before typing the next phrase
            }
        }

        // Function to trigger the "next phrase" control
        function nextPhrase() {
            // If there are more phrases to show, erase the current one and move to the next one
            if (currentReplicaIndex < replicasScreen1.length && !isErasing) {
                eraseCurrentText();
            }
        }

        // Listen for theme changes from Firebase
        onValue(themesRef, (snapshot) => {
            const themesData = snapshot.val();
            console.log("📥 Themes data received:", themesData);

            if (!themesData || !themesData.selectedTheme) {
                console.warn("⚠️ No selected theme found!");
                return;
            }

            const selectedTheme = themesData.selectedTheme; 
            console.log("🎨 Selected theme:", selectedTheme);

            // Check if the selected theme exists in the themes object
            const themeData = themesData[selectedTheme];
            
            if (!themeData) {
                console.warn(`⚠️ Theme data for "${selectedTheme}" not found!`);
                return;
            }

            if (!themeData.replicasScreen1 || themeData.replicasScreen1.length === 0) {
                console.warn(`⚠️ No valid replicas for screen 1 found for theme: ${selectedTheme}`);
                return;
            }

            // Update theme name
            document.getElementById("theme-name").textContent = themeData.title || "Loading...";

            // Dynamic call of new function
            const themeName = themeData.title.replace(/\s+/g, '') + replicasScreenKeyFunction;
            console.log('XXXXX'+themeName);
            console.log(myp5);

            if (myp5) {
                myp5.remove();
            }
            console.log(myp5);
            
            myp5 = window[themeName]();

            console.log(myp5);

            // Reset replica index and update phrases
            currentReplicaIndex = 0;
            
            console.log(replicasScreenKey);
            console.log(themeData);
            console.log();

            replicasScreen1 = themeData[replicasScreenKey]; 
            console.log(replicasScreen1);

            // Start displaying phrases from scratch
            showNextReplica(); // Automatically show the first phrase
        });

    </script>
    <script src="script1-1.js"></script>
</body>
</html>
