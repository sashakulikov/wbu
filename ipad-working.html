<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPad Theme Controller</title>
</head>
<body>
    <h1>–í—ã–±–æ—Ä —Ç–µ–º—ã</h1>
    <div id="themeButtons"></div>
    <h2 id="selectedTheme">–í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞: ‚Äî</h2>

    <h1>–†–µ–ø–ª–∏–∫–∏</h1>
    <h3>–≠–∫—Ä–∞–Ω 1:</h3>
    <p id="replicaText1">‚Äî</p>
    
    <h3>–≠–∫—Ä–∞–Ω 2:</h3>
    <p id="replicaText2">‚Äî</p>

    <button id="nextReplicaButton">–°–ª–µ–¥—É—é—â–∞—è —Ä–µ–ø–ª–∏–∫–∞</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARRByK3-QRN6BLv23JIPG7tUfcC3PU5Mk",
            authDomain: "sosa-test-bd8ca.firebaseapp.com",
            databaseURL: "https://sosa-test-bd8ca-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "sosa-test-bd8ca",
            storageBucket: "sosa-test-bd8ca.appspot.com",
            messagingSenderId: "709279438846",
            appId: "1:709279438846:web:cb0a718e5a01374dbe52af"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        console.log("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á—ë–Ω!");

        let selectedThemeKey = ""; 

        function loadThemes() {
            const themesRef = ref(database, "themes");
            get(themesRef).then(snapshot => {
                if (snapshot.exists()) {
                    const themesData = snapshot.val();
                    console.log("üî• Firebase themes:", themesData);

                    const container = document.getElementById("themeButtons");
                    container.innerHTML = '';

                    Object.keys(themesData).forEach(themeKey => {
                        if (themeKey.startsWith("theme")) {
                            let btn = document.createElement("button");
                            btn.textContent = themesData[themeKey].selectedTheme;
                            btn.onclick = () => selectTheme(themeKey);
                            container.appendChild(btn);
                        }
                    });

                } else {
                    console.error("‚ùå –î–∞–Ω–Ω—ã–µ –≤ Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.");
                }
            }).catch(error => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º:", error);
            });
        }

        function selectTheme(themeKey) {
            const ipadRef = ref(database, "themes/ipad");
            const displaysRef = ref(database, "themes/displays");

            update(ipadRef, { selectedTheme: themeKey, currentReplicaIndex1: 0, currentReplicaIndex2: 0 })
                .then(() => {
                    console.log(`‚úîÔ∏è –¢–µ–º–∞ ${themeKey} –≤—ã–±—Ä–∞–Ω–∞ –≤ Firebase`);
                })
                .catch(error => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã:", error);
                });

            update(displaysRef, { selectedTheme: themeKey, currentReplicaIndex1: 0, currentReplicaIndex2: 0 })
                .then(() => {
                    console.log(`‚úîÔ∏è –¢–µ–º–∞ ${themeKey} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ displays`);
                })
                .catch(error => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–º—ã –≤ displays:", error);
                });

            selectedThemeKey = themeKey; 

            console.log("‚úîÔ∏è –¢–µ–º–∞ –≤—ã–±—Ä–∞–Ω–∞:", themeKey);
            document.getElementById("selectedTheme").textContent = `–í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞: ${themeKey}`;

            loadReplicas(themeKey);
        }

        function loadReplicas(themeKey) {
            const themeRef = ref(database, `themes/${themeKey}`);
            get(themeRef).then(snapshot => {
                if (snapshot.exists()) {
                    const themeData = snapshot.val();
                    console.log("üì• –î–∞–Ω–Ω—ã–µ —Ç–µ–º—ã:", themeData);

                    const { replicasScreen1, replicasScreen2 } = themeData;

                    document.getElementById("replicaText1").textContent = replicasScreen1 ? replicasScreen1[0] || "‚Äî" : "‚Äî";
                    document.getElementById("replicaText2").textContent = replicasScreen2 ? replicasScreen2[0] || "‚Äî" : "‚Äî";
                } else {
                    console.error("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!");
                }
            }).catch(error => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–ø–ª–∏–∫:", error);
            });
        }

        function nextReplica() {
            if (!selectedThemeKey) return; 

            const ipadRef = ref(database, `themes/${selectedThemeKey}`); 

            get(ipadRef).then(snapshot => {
                if (!snapshot.exists()) return;

                const { replicasScreen1, replicasScreen2, currentReplicaIndex1 = 0, currentReplicaIndex2 = 0 } = snapshot.val();

                if (!replicasScreen1 || !replicasScreen2) return;

                let newIndex1 = (currentReplicaIndex1 + 1) % replicasScreen1.length;
                let newIndex2 = (currentReplicaIndex2 + 1) % replicasScreen2.length;

                console.log("‚¨ÜÔ∏è –ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å —ç–∫—Ä–∞–Ω–∞ 1:", newIndex1);
                console.log("‚¨ÜÔ∏è –ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å —ç–∫—Ä–∞–Ω–∞ 2:", newIndex2);

                update(ipadRef, {
                    currentReplicaIndex1: newIndex1,
                    currentReplicaIndex2: newIndex2
                }).then(() => {
                    console.log("‚úÖ –ò–Ω–¥–µ–∫—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ Firebase!");
                    loadReplicas(selectedThemeKey);
                }).catch(error => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤:", error);
                });

            }).catch(error => {
                console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ–º–µ –≤ Firebase:", error);
            });
        }

        document.getElementById("nextReplicaButton").addEventListener("click", nextReplica);

        function listenForUpdates() {
            const ipadRef = ref(database, `themes/${selectedThemeKey}`); 

            onValue(ipadRef, snapshot => {
                if (!snapshot.exists()) return;

                const { replicasScreen1, replicasScreen2, currentReplicaIndex1 = 0, currentReplicaIndex2 = 0 } = snapshot.val();

                if (!replicasScreen1 || !replicasScreen2) return;

                console.log(`üé≠ –ù–æ–≤–∞—è —Ä–µ–ø–ª–∏–∫–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ 1: ${replicasScreen1[currentReplicaIndex1]}`);
                console.log(`üé≠ –ù–æ–≤–∞—è —Ä–µ–ø–ª–∏–∫–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ 2: ${replicasScreen2[currentReplicaIndex2]}`);

                document.getElementById("replicaText1").textContent = replicasScreen1[currentReplicaIndex1] || "‚Äî";
                document.getElementById("replicaText2").textContent = replicasScreen2[currentReplicaIndex2] || "‚Äî";
            });
        }

        window.onload = () => {
            loadThemes();
            listenForUpdates();
        };
    </script>
</body>
</html>
